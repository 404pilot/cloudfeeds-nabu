<!--
    Oozie coordinator app to watch for a dump from Ballista.
  
    This Oozie coordinator takes the following parameters:

    - region         - the region to process data from. The region name is used
                       as part of a directory path where Ballista is expected
                       to write files in. 
    - emailToAddress - the email address to send error notifications. 
    - startTime      - the first day that the coordinator needs to materialize an
                       Usmu job/workflow. If startTime is "2015-02-04T00:00Z", then
                       a job that watches directory 2015-02-03 will materialize.
                       The format should be "yyyy-MM-ddThh:mmZ".
    - endTime        - the last day that the coordinator will materialize an Usmu
                       job/workflow. This is required parameter in Oozie. So we
                       will just need to set this to something arbitrarily long
                       in the future. The format should be "yyyy-MM-ddThh:mmZ".
-->
<coordinator-app name="FeedsImport-${region}" frequency="${coord:days(1)}" start="${startTime}" end="${endTime}" 
                 timezone="UTC" xmlns="uri:oozie:coordinator:0.1">
   <controls>
       <!-- Materialized jobs should wait 22 hours (=1320 minutes) before timing out. 
            They materialize in the hour specified in the ${startTime}, every day.
       -->
       <timeout>1320</timeout>
   </controls>
   <datasets>
      <!-- Every 15 minutes, the coordinator will check if a materialize job can run
           (i.e: the directory listed in uri-template exists)
       -->
      <dataset name="feeds_dump" frequency="${coord:minutes(15)}" initial-instance="${startTime}" timezone="UTC">
         <uri-template>${nameNode}/cloudfeeds/feeds_dump/${region}/${YEAR}-${MONTH}-${DAY}</uri-template>
         <done-flag>_SUCCESS</done-flag>
      </dataset>
   </datasets>
   <input-events>
      <data-in name="coordInput1" dataset="feeds_dump">
         <!--  The "date" directory should be the yesterday's date, as Ballista runs to dump data
               from the previous day. This is how you get the previous date.
         -->
         <instance>${coord:current(-1)}</instance>
      </data-in>
   </input-events>
   <action>
      <workflow>
         <app-path>${nameNode}/cloudfeeds/usmu/feedsImport-wf.xml</app-path>
         <configuration>
             <property>
                 <name>region</name>
                 <value>${region}</value>
             </property>
             <property>
                 <name>emailToAddress</name>
                 <value>${emailToAddress}</value>
             </property>
             <property>
                 <name>dateToProcess</name>
                 <value>${coord:formatTime(coord:dateOffset(coord:nominalTime(), -1, 'DAY'),"yyyy-MM-dd")}</value>
             </property>
         </configuration>
      </workflow>
   </action>     
</coordinator-app>

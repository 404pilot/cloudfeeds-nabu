<!--
    Oozie workflow to execute the following actions:

    1) Run Hive action "load_prefs.q", which will:
       a) create an external table pointing to a directory where Ballista dumps data
       b) read from the external table and write to a Hive partitioned table
       c) drops the external table
    2) Rename the directory containing files that were successfully processed
    3) Email notification to emailToAddress for any errors only

    The workflow takes the following parameters:
    
    - emailToAddress - the email address to send error notifications. 
    - hdfsDumpDir    - this is the fully qualified HDFS path where the workflow
                       needs to read exported data from Postgres DB dump
                       and writes to Hive. For example:
                          hdfs://myhadoop.cluster.host/cloudfeeds/prefs_dump/DFW
-->
<workflow-app name="usmu" 
	      xmlns="uri:oozie:workflow:0.4">

  <parameters>
    <property>
       <name>emailToAddress</name>
    </property>
    <property>
       <name>hdfsDumpDir</name>
    </property>
  </parameters>

  <start to="load_prefs"/>

  <action name="load_prefs">
    <hive xmlns="uri:oozie:hive-action:0.2">
      <job-tracker>${jobTracker}</job-tracker>
      <name-node>${nameNode}</name-node>
      <!--
         Currently /etc/hive/conf/hive-site.xml needs to be copied into workflow's directory
         and exist on HDFS.
      -->
      <job-xml>hive-site.xml</job-xml>

      <configuration>
	<property>
	  <name>mapred.job.queue.name</name>
	  <value>${queueName}</value>
	</property>
      </configuration>

      <!--
           Hive script which must exist in workflow directory on HDFS.
      -->
      <script>load_prefs.q</script>

      <!--
           Parameters referenced within Hive script.
      -->
      <param>INPUT_TABLE=dailyprefsdump</param>
      <param>INPUT_LOCATION=${replaceAll(hdfsDumpDir, nameNode, "")}</param>
    </hive>
    
    <ok to="cleanup"/>
    <error to="sendEmailKill"/>
  </action>

  <action name="cleanup">
     <fs>
         <!--
         Someone or some process needs to purge these
         -->
         <move source="${hdfsDumpDir}" target="${hdfsDumpDir}-${wf:id()}"/>
     </fs>
     <ok to="end"/>
     <error to="sendEmailKill"/>
  </action>

  <action name="sendEmailKill">
    <email xmlns="uri:oozie:email-action:0.1">
      <to>${emailToAddress}</to>
      <subject>Status of workflow ${wf:id()}</subject>
      <body>The workflow ${wf:id()} had issues and was killed. The error message is: ${wf:errorMessage(wf:lastErrorNode())}</body>
    </email>
    <ok to="fail"/>
    <error to="fail"/> 
  </action>

  <kill name="fail">
    <message>error message[${wf:errorMessage(wf:lastErrorNode())}]</message> 
  </kill>

  <end name="end"/>

</workflow-app>
